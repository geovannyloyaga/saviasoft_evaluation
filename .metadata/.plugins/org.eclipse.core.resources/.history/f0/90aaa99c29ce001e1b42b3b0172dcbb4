package com.saviasoft.backend;

import java.util.ArrayList;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionDefinition;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import com.saviasoft.backend.apirest.dao.PersonDao;
import com.saviasoft.backend.apirest.dto.ResponseDto;
import com.saviasoft.backend.apirest.dto.ResponseListDto;
import com.saviasoft.backend.apirest.entities.Person;
import com.saviasoft.backend.apirest.interfaces.IPersonService;

public class PersonService implements IPersonService {

	@Autowired
	private PersonDao personDao;

	public void setArticleDao(PersonDao personDao) {
		this.personDao = personDao;
	}

	@Autowired
	private PlatformTransactionManager transactionManager;
	
	@Override
	public ResponseDto<Person> save(Person person) {
		Person personCreated = null;
		ResponseDto<Person> responsePerson = new ResponseDto<Person>(200, null, null);
		
		DefaultTransactionDefinition definirTransaccion = new DefaultTransactionDefinition();
		definirTransaccion.setReadOnly(Boolean.FALSE);
		definirTransaccion.setIsolationLevel(TransactionDefinition.ISOLATION_DEFAULT);
		TransactionStatus statusTransaction = this.transactionManager.getTransaction(definirTransaccion);
		
		try {
			personCreated = this.personDao.save(person);
			if (personCreated != null && personCreated.getId() != null) {
				responsePerson.setResponseObject(personCreated);
				this.transactionManager.commit(statusTransaction);
				responsePerson.setCode(200);
			} else {					
				this.transactionManager.rollback(statusTransaction);
				responsePerson.setCode(409);
				responsePerson.setError("Error al momento de crear la persona");
			}
			return responsePerson;
		} catch (Exception e) {
			this.transactionManager.rollback(statusTransaction);
			responsePerson.setCode(409);
			responsePerson.setError("Error al momento de crear la persona");
			return responsePerson;
		} finally {
			personCreated = null;
			responsePerson = null;
			definirTransaccion = null;
			statusTransaction = null;
		}
	}

	@Override
	public ResponseDto<Person> update(Person person) {
		Person personUpdated = null;
		ResponseDto<Person> responsePerson = new ResponseDto<Person>(200, null, null);
		
		DefaultTransactionDefinition definirTransaccion = new DefaultTransactionDefinition();
		definirTransaccion.setReadOnly(Boolean.FALSE);
		definirTransaccion.setIsolationLevel(TransactionDefinition.ISOLATION_DEFAULT);
		TransactionStatus statusTransaction = this.transactionManager.getTransaction(definirTransaccion);
		
		try {
			personUpdated = this.personDao.update(person);
			if (personUpdated != null && personUpdated.getId() != null) {
				responsePerson.setResponseObject(personUpdated);
				this.transactionManager.commit(statusTransaction);
				responsePerson.setCode(200);	
			} else {
				this.transactionManager.rollback(statusTransaction);
				responsePerson.setCode(409);
				responsePerson.setError("Error al momento de crear la persona");
			}
			return responsePerson;
		} catch (Exception e) {
			this.transactionManager.rollback(statusTransaction);
			responsePerson.setCode(409);
			responsePerson.setError("Error al momento de crear la persona");
			return responsePerson;
		} finally {
			personUpdated = null;
			responsePerson = null;
			definirTransaccion = null;
			statusTransaction = null;
		}
	}

	@Override
	public ResponseDto<Person> delete(Person person) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	@Transactional(readOnly = true)
	public ResponseListDto<Person> getPersonList() {
		ResponseListDto<Person> responsePersonList = new ResponseListDto<Person>(200, null, new ArrayList<>(), 0);
		List<Person> foundArticleList = null;
		try {
			foundArticleList = this.articleDao.getArticleList();
			responsePersonList.setResponseList(foundArticleList);
			if (foundArticleList.isEmpty()) {
				responsePersonList.setCode(200);
			} else {
				responsePersonList.setCode(409);
				responsePersonList.setError("Error al momento de obtener la lista de artículos");
			}
			return responsePersonList;
		} catch (Exception e) {
			responsePersonList.setCode(409);
			responsePersonList.setError("Error al momento de obtener la lista de artículos");
			return responsePersonList;
		} finally {
			responsePersonList = null;
			foundArticleList = null;
		}
	}

}
